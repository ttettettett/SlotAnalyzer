<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Pivot Table Viewer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { margin: 20px; font-family: Arial, sans-serif; }
        #controls { display: none; margin-bottom: 20px; }
        select, button, label { margin-right: 10px; margin-bottom: 10px; }
        .table-container { overflow: auto; max-height: 80vh; position: relative; }
        table { border-collapse: collapse; width: max-content; }
        th, td { border: 1px solid #ccc; padding: 4px 8px; text-align: center; background: #fff; white-space: nowrap; box-sizing: border-box; }
        th:nth-child(n+4) { position: sticky; top: 0; background-color: #f0f0f0; z-index: 3; }
        th:nth-child(1) { position: sticky; top: 0; left: 0; background-color: #f0f0f0; z-index: 5; width:50px; }
        th:nth-child(2) { position: sticky; top: 0; left: 50px; background-color: #f0f0f0; z-index: 5; width:80px; }
        th:nth-child(3) { position: sticky; top: 0; left: 130px; background-color: #f0f0f0; z-index: 5; width:60px; }
        td:nth-child(1) { position: sticky; left: 0; z-index: 4; width:50px; }
        td:nth-child(2) { position: sticky; left: 50px; z-index: 4; width:80px; }
        td:nth-child(3) { position: sticky; left: 130px; z-index:4; width:60px; }
    </style>
</head>
<body>
    <label class="btn btn-primary">
        <input type="file" id="fileInput" accept=".xlsx,.xls" hidden> Excelを選択
    </label>
    <div id="controls">
        <select id="storeSelect" class="form-select d-inline-block" style="width:auto;"></select>
        <select id="typeSelect" class="form-select d-inline-block" style="width:auto;">
            <option value="台番号">台</option>
            <option value="機種名">機種</option>
        </select>
        <select id="dateSelect" multiple class="form-select d-inline-block" style="width:auto;"></select>
        <button id="display" class="btn btn-success">表示</button>
    </div>
    <div id="tableContainer"></div>

    <script>
        let originalData = [];
        const fileInput = document.getElementById('fileInput');
        const controls = document.getElementById('controls');
        const storeSelect = document.getElementById('storeSelect');
        const typeSelect = document.getElementById('typeSelect');
        const dateSelect = document.getElementById('dateSelect');
        const displayBtn = document.getElementById('display');
        const tableContainer = document.getElementById('tableContainer');

        function formatDate(d) {
            const date = new Date(d);
            if (isNaN(date)) return d;
            const mm = String(date.getMonth()+1).padStart(2,'0');
            const dd = String(date.getDate()).padStart(2,'0');
            const days = ['日','月','火','水','木','金','土'];
            return `${mm}/${dd}(${days[date.getDay()]})`;
        }

        fileInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = evt => {
                const data = new Uint8Array(evt.target.result);
                const wb = XLSX.read(data, { type: 'array' });
                const sheet = wb.SheetNames[0];
                originalData = XLSX.utils.sheet_to_json(wb.Sheets[sheet]);
                if (!originalData.length) { alert('データがありません'); return; }
                const stores = [...new Set(originalData.map(r=>r['店舗名']))];
                const dates = [...new Set(originalData.map(r=>r['日付']))].sort((a,b)=>new Date(b)-new Date(a));
                storeSelect.innerHTML = stores.map(s=>`<option>${s}</option>`).join('');
                dateSelect.innerHTML = dates.map(d=>`<option value="${d}">${formatDate(d)}</option>`).join('');
                controls.style.display = 'block';
            };
            reader.readAsArrayBuffer(file);
        });

        displayBtn.addEventListener('click', () => {
            const store = storeSelect.value;
            const typeKey = typeSelect.value;
            const dates = Array.from(dateSelect.selectedOptions).map(o=>o.value);
            const filtered = originalData.filter(r=>r['店舗名']===store && dates.includes(r['日付']));

            let rows = [];
            if (typeKey === '台番号') {
                const keys = [...new Set(filtered.map(r=>r['台番号']))];
                rows = keys.map(key => ({ key, values: {}, machine: '', avg: 0 }));
                rows.forEach(row => {
                    const recs = filtered.filter(r=>r['台番号']===row.key);
                    row.machine = recs[0] ? recs[0]['機種名'] : '';
                    let total = 0;
                    dates.forEach(d => {
                        const sum = recs.filter(r=>r['日付']===d).reduce((s,r)=>s+(r['差枚数']||0),0);
                        row.values[d] = sum;
                        total += sum;
                    });
                    row.avg = dates.length ? Math.round(total / dates.length) : 0;
                });
            } else {
                const keys = [...new Set(filtered.map(r=>r['機種名']))];
                rows = keys.map(key => {
                    const recs = filtered.filter(r=>r['機種名']===key);
                    const count = recs.length;
                    const sumAll = recs.reduce((s,r)=>s+(r['差枚数']||0),0);
                    const avgAll = count ? Math.round(sumAll/count) : 0;
                    return { key, count, avgAll };
                });
                rows.sort((a,b)=>b.avgAll - a.avgAll);
            }

            let html = '<table><tr>';
            if (typeKey==='台番号') html += '<th>台番号</th><th>機種名</th><th>平均</th>'; else html += '<th>機種名</th><th>台数</th><th>平均</th>';
            html += dates.map(d=>`<th>${formatDate(d)}</th>`).join('') + '</tr>';

            rows.forEach(row => {
                html += '<tr>';
                if (typeKey==='台番号') {
                    let styleAvg = '';
                    const avg = row.avg;
                    if (avg>0&&avg<=1000) styleAvg='background:#ffffcc';
                    else if (avg>=1001&&avg<=2000) styleAvg='background:orange';
                    else if (avg>=2001&&avg<=3000) styleAvg='background:red';
                    else if (avg>=3001) styleAvg='background:purple';
                    html += `<td>${row.key}</td><td>${row.machine}</td><td${styleAvg?` style="${styleAvg}"`:``}>${avg}</td>`;
                    dates.forEach(d=>{
                        const sum = row.values[d] || 0;
                        let style='';
                        if(sum>0&&sum<=1000) style='background:#ffffcc';
                        else if(sum>=1001&&sum<=2000) style='background:orange';
                        else if(sum>=2001&&sum<=3000) style='background:red';
                        else if(sum>=3001) style='background:purple';
                        const displaySum = (sum === 0 ? '0' : sum);
                        html += `<td${style?` style="${style}"`:``}>${displaySum}</td>`;
                    });
                } else {
                    html += `<td>${row.key}</td><td>${row.count}</td><td>${row.avgAll}</td>`;
                    dates.forEach(d=>{
                        const recs = filtered.filter(r=>r['機種名']===row.key && r['日付']===d);
                        const avg = recs.length ? Math.round(recs.reduce((s,r)=>s+(r['差枚数']||0),0)/recs.length) : 0;
                        let style='';
                        if(avg>0&&avg<=1000) style='background:#ffffcc';
                        else if(avg>=1001&&avg<=2000) style='background:orange';
                        else if(avg>=2001&&avg<=3000) style='background:red';
                        else if(avg>=3001) style='background:purple';
                        const displayAvg = (avg === 0 ? '0' : avg);
                        html += `<td${style?` style="${style}"`:``}>${displayAvg}</td>`;
                    });
                }
                html += '</tr>';
            });
            html += '</table>';
            tableContainer.innerHTML = `<div class="table-container">${html}</div>`;
            const tableElem = tableContainer.querySelector('table');
            const tableRows = tableElem.querySelectorAll('tr');
            tableRows.forEach((tr, rowIndex) => {
                const cells = tr.children;
                for (let i = 0; i < 3; i++) {
                    const cell = cells[i];
                    const left = cell.offsetLeft;
                    cell.style.position = 'sticky';
                    cell.style.left = left + 'px';
                    cell.style.zIndex = rowIndex === 0 ? 5 : 4;
                    cell.style.backgroundColor = rowIndex === 0 ? '#f0f0f0' : '#fff';
                }
            });
        });
    </script>
</body>
</html>
